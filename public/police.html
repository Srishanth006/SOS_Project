<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tamil Nadu Police Command Center</title>
    <h1>Portal for S.A.F.E Protoype Signal recieving </h1>
    <!-- Link to the matching style.css file -->
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>

    <header class="app-header">
        <!-- Professional Logo/Emblem -->
        <svg class="header-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="48" fill="#0d6efd" stroke="#0a58ca" stroke-width="4"/>
            <circle cx="50" cy="50" r="15" fill="none" stroke="#fff" stroke-width="4"/>
            <path d="M50 20 L50 80 M20 50 L80 50 M30 30 L70 70 M30 70 L70 30" stroke="#fff" stroke-width="4"/>
        </svg>
        <h1 class="header-title">Police Command Center - S.A.F.E. Alerts</h1>
        <div class="alert-banner" id="alertBanner" style="display:none;">
            <span class="badge" id="alertCount">0</span>
            ACTIVE INCIDENT(S)
        </div>
    </header>

    <main class="dashboard-grid">
        
        <!-- Left Column: Map -->
        <section class="panel">
            <div id="map"></div>
        </section>

        <!-- Right Column: Incident Log -->
        <section class="panel">
            <div class="panel-header">
                <h2>Incident Log</h2>
                <button id="clearButton" class="btn btn-danger">Clear All Incidents</button>
            </div>
            <div class="list" id="reportList"></div>
        </section>

    </main>

    <audio id="alertSound" preload="auto">
        <source src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-the-sound-pack-tree/tspt_siren_short_burst_01.mp3" type="audio/mpeg" />
    </audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script>
        // --- YOUR FIREBASE BACKEND CODE (ENTIRELY UNCHANGED) ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDJG7XujjzGVGrdiDzYjPgdw34mFw6mkIA",
            authDomain: "alert-system-a9_REPLACE_THIS_a9ab.firebaseapp.com", // Example placeholder
            databaseURL: "https://alert-system-a99ab-default-rtdb.firebaseio.com",
            projectId: "alert-system-a99ab",
            storageBucket: "alert-system-a99ab.appspot.com", // Example placeholder
            messagingSenderId: "301074962948",
            appId: "1:301074962948:web:a32821f6312145e1627351",
            measurementId: "G-0C5EPXJGED"
        };
        const app = firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();
        const reportsRef = db.ref('sos_reports');
        const reportList = document.getElementById('reportList');
        const alertBanner = document.getElementById('alertBanner');
        const alertCount = document.getElementById('alertCount');
        const clearButton = document.getElementById('clearButton');
        const alertSound = document.getElementById('alertSound');
        const map = L.map('map').setView([20.5937, 78.9629], 5); // Center on India
        const markers = {};
        const accuracyCircles = {};
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

        function playSound() { alertSound.play().catch(error => console.log("Audio play blocked.", error)); }
        function updateUI() { const reportCount = Object.keys(markers).length; alertCount.textContent = reportCount; alertBanner.style.display = reportCount > 0 ? 'flex' : 'none'; }
        
        reportsRef.on('child_added', (snapshot) => {
            const reportId = snapshot.key;
            const report = snapshot.val();
            playSound();
            const lat = report.location.lat;
            const lng = report.location.lng;
            const accuracy = report.location.accuracy;

            const item = document.createElement('div');
            item.className = 'report-item';
            item.id = `item-${reportId}`;
            item.innerHTML = `
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <strong>Active Alert</strong>
                </div>
                <div class="coords">Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}</div>
                <div class="meta accuracy-info">Accuracy: ±${Math.round(accuracy)}m</div>
                <div class="meta">Received: ${new Date(report.createdAt).toLocaleString()}</div>
                <div class="meta" id="updated-${reportId}"></div>
            `;
            reportList.prepend(item);

            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>SOS Alert</b><br>Accuracy: ±${Math.round(accuracy)}m`);
            markers[reportId] = marker;
            const circle = L.circle([lat, lng], { radius: accuracy, color: '#dc3545', fillColor: '#dc3545', fillOpacity: 0.15, weight: 1 }).addTo(map);
            accuracyCircles[reportId] = circle;
            map.fitBounds(circle.getBounds(), { padding: [50, 50] });
            updateUI();
            item.addEventListener('click', () => { map.fitBounds(accuracyCircles[reportId].getBounds(), { padding: [50, 50] }); marker.openPopup(); });
        });

        reportsRef.on('child_changed', (snapshot) => {
             const reportId = snapshot.key;
             const report = snapshot.val();
             if (markers[reportId]) {
                 const lat = report.location.lat;
                 const lng = report.location.lng;
                 const accuracy = report.location.accuracy;
                 const newLatLng = [lat, lng];
                 markers[reportId].setLatLng(newLatLng);
                 accuracyCircles[reportId].setLatLng(newLatLng).setRadius(accuracy);
                 const item = document.getElementById(`item-${reportId}`);
                 item.querySelector('.coords').textContent = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;
                 item.querySelector('.accuracy-info').textContent = `Accuracy: ±${Math.round(accuracy)}m`;
                 const updatedAtEl = document.getElementById(`updated-${reportId}`);
                 if (report.updatedAt) {
                     updatedAtEl.textContent = `Updated: ${new Date(report.updatedAt).toLocaleString()}`;
                 }
             }
        });

        reportsRef.on('child_removed', (snapshot) => {
            const reportId = snapshot.key;
            if (markers[reportId]) {
                map.removeLayer(markers[reportId]);
                delete markers[reportId];
                map.removeLayer(accuracyCircles[reportId]);
                delete accuracyCircles[reportId];
                const item = document.getElementById(`item-${reportId}`);
                if (item) item.remove();
                updateUI();
            }
        });

        clearButton.addEventListener('click', () => { if (confirm('Are you sure you want to remove all incidents?')) { reportsRef.set(null); } });
    </script>
</body>
</html>