<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tamil Nadu Police Dashboard â€” SOS Alerts</title>
    <link rel="stylesheet" href="/styles.css" />
    <!-- Leaflet Maps Library CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>
    <header class="app-header">
        <h1>Police Dashboard</h1>
        <div class="alert-banner" id="alertBanner" style="display:none;">
            <span class="badge" id="alertCount">0</span>
            ACTIVE SOS ALERT
        </div>
    </header>

    <main class="dashboard">
        <section class="panel left">
            <div id="map"></div>
        </section>
        <section class="panel right">
            <div class="panel-header">
                <h2>Incoming Reports</h2>
                <button id="clearButton" class="btn">Clear All</button>
            </div>
            <div class="list" id="reportList"></div>
        </section>
    </main>

    <!-- Sound for new alerts -->
    <audio id="alertSound" preload="auto">
        <source src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-the-sound-pack-tree/tspt_siren_short_burst_01.mp3" type="audio/mpeg" />
    </audio>

    <!-- Leaflet Maps Library JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script>
        // --- Your Firebase Configuration has been integrated ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDJG7XujjzGVGrdiDzYjPgdw34mFw6mkIA",
            authDomain: "alert-system-a99ab.firebaseapp.com",
            databaseURL: "https://alert-system-a99ab-default-rtdb.firebaseio.com",
            projectId: "alert-system-a99ab",
            storageBucket: "alert-system-a99ab.firebasestorage.app",
            messagingSenderId: "301074962948",
            appId: "1:301074962948:web:a32821f6312145e1627351",
            measurementId: "G-0C5EPXJGED"
        };
        // --------------------------------------------------------------------

        // Initialize Firebase
        const app = firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();
        const reportsRef = db.ref('sos_reports');

        // UI Elements
        const reportList = document.getElementById('reportList');
        const alertBanner = document.getElementById('alertBanner');
        const alertCount = document.getElementById('alertCount');
        const clearButton = document.getElementById('clearButton');
        const alertSound = document.getElementById('alertSound');
        
        // Map State
        const map = L.map('map').setView([20.5937, 78.9629], 5); // Center on India
        const markers = {}; // Object to store map markers by report ID

        // Add map tiles (the map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Function to play sound safely
        function playSound() {
            alertSound.play().catch(error => console.log("Audio play blocked by browser.", error));
        }

        // Function to update the list of reports and the alert banner
        function updateUI() {
            const reportCount = Object.keys(markers).length;
            alertCount.textContent = reportCount;
            alertBanner.style.display = reportCount > 0 ? 'flex' : 'none';
        }

        // --- Firebase Listeners ---

        // 1. Listen for new reports being added
        reportsRef.on('child_added', (snapshot) => {
            const reportId = snapshot.key;
            const report = snapshot.val();
            
            console.log('New Report Received:', reportId, report);
            playSound();

            // Create HTML for the report list
            const item = document.createElement('div');
            item.className = 'report-item';
            item.id = `item-${reportId}`;
            item.innerHTML = `
                <div class="coords">Lat: ${report.location.lat.toFixed(5)}, Lng: ${report.location.lng.toFixed(5)}</div>
                <div class="meta">Received: ${new Date(report.createdAt).toLocaleString()}</div>
                <div class="meta" id="updated-${reportId}"></div>
            `;
            // Add to the top of the list
            reportList.prepend(item);

            // Create a marker on the map
            const marker = L.marker([report.location.lat, report.location.lng]).addTo(map);
            marker.bindPopup(`<b>SOS Alert</b><br>Received: ${new Date(report.createdAt).toLocaleString()}`);
            markers[reportId] = marker;

            // Center the map on the new alert
            map.setView([report.location.lat, report.location.lng], 15);

            // Update banner
            updateUI();

            // Add click listener to focus on this marker
            item.addEventListener('click', () => {
                map.setView([marker.getLatLng().lat, marker.getLatLng().lng], 16);
                marker.openPopup();
            });
        });

        // 2. Listen for changes (live location updates) to existing reports
        reportsRef.on('child_changed', (snapshot) => {
            const reportId = snapshot.key;
            const report = snapshot.val();

            if (markers[reportId]) {
                const newLatLng = [report.location.lat, report.location.lng];
                // Move the marker smoothly to the new location
                markers[reportId].setLatLng(newLatLng);
                
                // Update the coordinates in the list item
                const item = document.getElementById(`item-${reportId}`);
                item.querySelector('.coords').textContent = `Lat: ${report.location.lat.toFixed(5)}, Lng: ${report.location.lng.toFixed(5)}`;
                
                // Update the 'updated at' timestamp
                const updatedAtEl = document.getElementById(`updated-${reportId}`);
                if(report.updatedAt) {
                    updatedAtEl.textContent = `Updated: ${new Date(report.updatedAt).toLocaleString()}`;
                }
            }
        });

        // 3. Listen for a report being removed (for real-time sync)
        reportsRef.on('child_removed', (snapshot) => {
            const reportId = snapshot.key;
            if (markers[reportId]) {
                map.removeLayer(markers[reportId]); // Remove marker from map
                delete markers[reportId]; // Remove from our state
                
                const item = document.getElementById(`item-${reportId}`);
                if (item) item.remove(); // Remove item from list
                
                updateUI();
            }
        });
        
        // Button to clear all reports from the database
        clearButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to remove all SOS reports?')) {
                reportsRef.set(null); // This deletes all data at the 'sos_reports' path
            }
        });

    </script>
</body>
</html>