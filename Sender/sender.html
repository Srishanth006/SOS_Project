<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SOS Sender (Firebase Live)</title>
    <style>
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#0f172a;color:#e2e8f0;display:flex;align-items:center;justify-content:center;height:100vh}
      .card{background:#101a3a;border:1px solid #233053;border-radius:12px;padding:24px;max-width:420px;width:92%}
      h1{margin:0 0 8px 0;font-size:20px}
      p{margin:6px 0 16px 0;color:#94a3b8}
      .btn{display:block;width:100%;padding:12px 14px;border-radius:10px;border:1px solid #233053;background:#3b82f6;color:#fff;cursor:pointer;font-size:16px}
      .btn.alt{background:#0b1530}
      .row{display:flex;gap:8px;margin-top:8px}
      .status{margin-top:10px;color:#94a3b8}
      .ok{color:#22c55e} .err{color:#ef4444}
      .small{font-size:12px;color:#94a3b8;margin-top:6px}
    </style>
    <!-- Firebase SDKs (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div class="card">
      <h1>Emergency SOS</h1>
      <p>Press Start SOS to share your live location anonymously with authorities.</p>
      <button id="startBtn" class="btn">Start SOS</button>
      <div class="row">
        <button id="stopBtn" class="btn alt">Stop</button>
      </div>
      <div id="status" class="status"></div>
      <div class="small">Keep this page open while SOS is active.</div>
    </div>

    <script>
      // --- Your Firebase Configuration is now integrated ---
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyDJG7XujjzGVGrdiDzYjPgdw34mFw6mkIA",
        authDomain: "alert-system-a99ab.firebaseapp.com",
        databaseURL: "https://alert-system-a99ab-default-rtdb.firebaseio.com",
        projectId: "alert-system-a99ab",
        storageBucket: "alert-system-a99ab.firebasestorage.app",
        messagingSenderId: "301074962948",
        appId: "1:301074962948:web:a32821f6312145e1627351",
        measurementId: "G-0C5EPXJGED"
      };
      // ----------------------------------------------------

      // Initialize Firebase with your configuration
      const app = firebase.initializeApp(FIREBASE_CONFIG);
      const db = firebase.database(app);
      const baseRef = db.ref('sos_reports');

      // Get references to the UI elements
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');

      let reportKey = null; // This will store the unique ID for the current user's report
      let watchId = null;   // This will store the ID for the geolocation watcher

      // Function to update the status message shown to the user
      function setStatus(msg, cls){ statusEl.textContent = msg; statusEl.className = 'status ' + (cls||''); }

      // Function to create the initial report in Firebase
      function createReport(initial){
        const ref = baseRef.push(); // .push() creates a new unique ID
        return ref.set(initial).then(()=> ref.key);
      }

      // Function to update an existing report in Firebase
      function updateReport(key, partial){
        return baseRef.child(key).update(partial);
      }

      // Starts the continuous location tracking
      function startWatch(){
        if(!navigator.geolocation){ setStatus('Geolocation not supported', 'err'); return; }
        
        watchId = navigator.geolocation.watchPosition(async (pos)=>{
          if(!reportKey) return; // Don't do anything if SOS has been stopped

          const { latitude, longitude, accuracy } = pos.coords;
          try {
            // Update the location and timestamp for the existing report
            await updateReport(reportKey, { 
              location: { lat: latitude, lng: longitude, accuracy: accuracy }, 
              updatedAt: new Date().toISOString() 
            });
            setStatus('Sharing live location…', 'ok');
          } catch(e){ 
            console.warn("Could not update report:", e); 
          }
        }, (err)=>{
          console.warn(err); 
          if(err.code === 1) setStatus('Location blocked. Allow in browser.', 'err');
        }, { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 });
      }

      // Main function that runs when the "Start SOS" button is clicked
      async function startSOS(){
        setStatus('Starting…');
        startBtn.disabled = true; // Disable button to prevent multiple clicks
        try{
          // Get a quick, one-time position to start the report
          const initialPosition = await new Promise((resolve, reject) => 
            navigator.geolocation.getCurrentPosition(resolve, reject, { 
              enableHighAccuracy: true, 
              timeout: 15000, 
              maximumAge: 0 
            })
          );

          const initialReportData = {
            createdAt: new Date().toISOString(),
            source: 'anonymous',
            location: { 
              lat: initialPosition.coords.latitude, 
              lng: initialPosition.coords.longitude, 
              accuracy: initialPosition.coords.accuracy 
            }
          };
          
          // Create the report in Firebase and get the unique key
          reportKey = await createReport(initialReportData);
          setStatus('SOS active. Report ID: ' + reportKey, 'ok');
          
          // Now, start the live updates
          startWatch();

        }catch(e){ 
          console.error(e); 
          let errorMsg = 'Failed to get location.';
          if (e.code === 1) errorMsg = 'Location permission denied.';
          setStatus(errorMsg, 'err'); 
          startBtn.disabled = false; // Re-enable the button if it fails
        }
      }

      // Stops the live location updates
      function stopSOS(){
        if(watchId !== null){ 
          navigator.geolocation.clearWatch(watchId); 
          watchId = null; 
        }
        reportKey = null; // Clear the report key to stop updates
        setStatus('SOS stopped.');
        startBtn.disabled = false;
      }

      // Attach the functions to the button clicks
      startBtn.addEventListener('click', startSOS);
      stopBtn.addEventListener('click', stopSOS);
    </script>
  </body>
</html>